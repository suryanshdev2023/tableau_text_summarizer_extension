<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tableau GPT Assistant - AI Extension</title>
    <script src="tableau.extensions.1.latest.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f8f9fa;
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }

        .container {
            background: white;
            padding: 20px;
            width: 100%;
            min-height: 100vh;
            box-sizing: border-box;
            position: relative;
        }

        .header {
            text-align: left;
            margin-bottom: 15px;
            position: relative;
            padding: 10px 0;
            border-bottom: 1px solid #e1e5e9;
        }

        .header h1 {
            color: #333;
            font-size: 1.8em;
            margin-bottom: 0;
        }

        .settings-btn {
            position: absolute;
            top: 10px;
            right: 0;
            background: linear-gradient(135deg, #4285f4 0%, #9c27b0 100%);
            color: white;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .settings-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(66, 133, 244, 0.3);
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        select, input, textarea {
            width: 100%;
            padding: 4px 10px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
            background-color: #fff;
            color: #222;
            min-width: 200px;
            height: 32px;
        }

        /* Specific styling for worksheet and column dropdowns for visibility */
        #worksheetSelect, #columnSelect {
            background-color: #fff;
            color: #222;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            height: 32px;
            min-width: 200px;
            width: 100%;
            margin-bottom: 8px;
            padding: 4px 10px;
            line-height: normal;
        }

        .modal select, .modal input, .modal textarea {
            padding: 15px;
            font-size: 16px;
        }

        select:focus, input:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            resize: vertical;
            min-height: 60px;
            font-family: inherit;
        }

        .btn {
            background: linear-gradient(135deg, #4285f4 0%, #9c27b0 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
            margin: 10px 0;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(66, 133, 244, 0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        }

        .btn-secondary:hover {
            box-shadow: 0 8px 25px rgba(108, 117, 125, 0.3);
        }

        .modal .btn {
            padding: 15px 30px;
            font-size: 16px;
            margin: 15px 5px;
        }

        .result-container {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 3px solid #667eea;
            display: none;
        }

        .result-container h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .result-text {
            line-height: 1.5;
            color: #555;
            background: white;
            padding: 12px;
            border-radius: 4px;
            border: 1px solid #e1e5e9;
            font-size: 13px;
        }

        /* Rich text formatting styles */
        .result-text h1, .result-text h2, .result-text h3, .result-text h4, .result-text h5, .result-text h6 {
            color: #333;
            margin: 20px 0 12px 0;
            font-weight: 600;
            line-height: 1.3;
        }

        .result-text h1 { 
            font-size: 1.5em; 
            border-bottom: 2px solid #667eea; 
            padding-bottom: 8px; 
            margin-top: 0;
        }
        .result-text h2 { 
            font-size: 1.3em; 
            border-bottom: 1px solid #e1e5e9; 
            padding-bottom: 5px; 
            margin-top: 25px;
        }
        .result-text h3 { 
            font-size: 1.2em; 
            margin-top: 20px;
            color: #555;
        }
        .result-text h4 { font-size: 1.1em; }

        .result-text p {
            margin: 12px 0;
            line-height: 1.6;
            color: #444;
        }

        .result-text strong, .result-text b {
            font-weight: 600;
            color: #333;
        }

        .result-text em, .result-text i {
            font-style: italic;
            color: #666;
        }

        .result-text ul, .result-text ol {
            margin: 15px 0;
            padding-left: 30px;
        }

        .result-text li {
            margin: 8px 0;
            line-height: 1.5;
            color: #444;
        }

        .result-text ul li {
            list-style-type: disc;
        }

        .result-text ol li {
            list-style-type: decimal;
        }

        .result-text blockquote {
            border-left: 4px solid #667eea;
            margin: 20px 0;
            padding: 15px 20px;
            background: #f8f9fa;
            font-style: italic;
            color: #555;
            border-radius: 0 4px 4px 0;
        }

        .result-text code {
            background: #f1f3f4;
            padding: 3px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            color: #d73a49;
        }

        .result-text pre {
            background: #f6f8fa;
            border: 1px solid #e1e5e9;
            border-radius: 4px;
            padding: 15px;
            overflow-x: auto;
            margin: 20px 0;
        }

        .result-text pre code {
            background: none;
            padding: 0;
            color: #333;
        }

        .result-text hr {
            border: none;
            border-top: 2px solid #e1e5e9;
            margin: 25px 0;
        }

        .result-text table {
            border-collapse: collapse;
            width: 100%;
            margin: 15px 0;
            font-size: 0.9em;
        }

        .result-text th, .result-text td {
            border: 1px solid #e1e5e9;
            padding: 8px 12px;
            text-align: left;
        }

        .result-text th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        .result-text tr:nth-child(even) {
            background: #f8f9fa;
        }

        .format-toggle-btn {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .format-toggle-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
        }

        .format-toggle-btn.active {
            background: linear-gradient(135deg, #4285f4 0%, #9c27b0 100%);
        }

        .loading {
            display: none;
            text-align: center;
            padding: 15px;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .status {
            margin: 10px 0;
            padding: 8px;
            border-radius: 6px;
            font-size: 13px;
        }

        .status.info {
            background: #e3f2fd;
            color: #1976d2;
            border: 1px solid #bbdefb;
        }

        .status.success {
            background: #e8f5e8;
            color: #2e7d32;
            border: 1px solid #c8e6c9;
        }

        .status.error {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ffcdd2;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.3);
        }

        .modal-content {
            background-color: white;
            margin: 2% auto;
            padding: 30px;
            border-radius: 15px;
            width: 95%;
            max-width: 800px;
            height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
        }

        .modal-header {
            text-align: center;
            margin-bottom: 35px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e1e5e9;
        }

        .modal-header h2 {
            color: #333;
            font-size: 2em;
            margin-bottom: 8px;
        }

        .modal-header p {
            font-size: 1.1em;
            color: #666;
        }

        .close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            color: #999;
        }

        .close:hover {
            color: #333;
        }



        .config-status {
            padding: 8px 12px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 12px;
            text-align: left;
        }

        .config-status.configured {
            background: #e8f5e8;
            color: #2e7d32;
            border: 1px solid #c8e6c9;
        }

        .config-status.not-configured {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .save-prompt-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            background: linear-gradient(135deg, #4285f4 0%, #9c27b0 100%);
            color: white;
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s, box-shadow 0.2s;
            z-index: 10;
        }

        .save-prompt-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(66, 133, 244, 0.3);
        }

        .save-prompt-btn:active {
            transform: scale(0.95);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <button class="settings-btn" onclick="openSettings()" title="Settings">‚öôÔ∏è</button>
            <h1>ü§ñ Tableau GPT Assistant</h1>
        </div>

        <div class="config-status" id="configStatus">
            Click settings to configure your worksheet and API key
        </div>

        <div class="form-group">
            <label for="customPrompt">Custom Prompt:</label>
            <div style="position: relative;">
                <textarea id="customPrompt" placeholder="Enter your custom prompt here...">Provide a comprehensive summary of the following text entries. Focus on the key themes, main points, and overall insights:</textarea>
                <button class="save-prompt-btn" onclick="saveCustomPrompt()" title="Save Custom Prompt">üíæ</button>
            </div>
        </div>

        <button class="btn" id="summarizeBtn" onclick="summarizeText()">
            üöÄ Generate
        </button>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Processing your data with AI...</p>
        </div>

        <div id="status"></div>

        <div class="result-container" id="resultContainer">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h3>üìã Result</h3>
                <button class="format-toggle-btn" onclick="toggleFormat()" id="formatToggle" title="Toggle formatting">
                    üìù Plain Text
                </button>
            </div>
            <div class="result-text" id="resultText"></div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeSettings()">&times;</span>
            <div class="modal-header">
                <h2>‚öôÔ∏è Tableau GPT Assistant Configuration</h2>
                <p>Configure your data source and AI settings</p>
                <div style="background: #fff3cd; padding: 12px; border-radius: 6px; margin-top: 10px; border-left: 3px solid #ffc107;">
                    <small style="color: #856404; font-weight: 500;">
                        üîê <strong>Data Protection:</strong> Your settings are stored locally and encrypted by Tableau. API keys and sensitive data are encrypted before saving to prevent exposure in exported workbooks.
                    </small>
                </div>
            </div>

            <div class="form-group" style="margin-bottom: 10px;">
                <label for="worksheetSelect" style="font-size: 13px;">Select Worksheet:</label>
                <select id="worksheetSelect" style="height: 32px; font-size: 13px; width: 100%;">
                    <option value="">Loading worksheets...</option>
                </select>
            </div>
            <div class="form-group" style="margin-bottom: 15px;">
                <label for="columnSelect" style="font-size: 13px;">Select Text Column:</label>
                <select id="columnSelect" style="height: 32px; font-size: 13px; width: 100%;">
                    <option value="">Select a worksheet first</option>
                </select>
            </div>

            <div class="form-group">
                <label for="tokenLimit">Token Limit:</label>
                <input type="number" id="tokenLimit" value="5000" min="1000" max="15000" placeholder="5000">
                <small style="color: #666; font-size: 13px;">Maximum tokens to send to AI (affects cost and processing time)</small>
            </div>

            <div class="form-group">
                <label for="systemRole">System Role:</label>
                <textarea id="systemRole" rows="2" placeholder="Define the AI's role and behavior..." style="font-size: 13px; min-height: 40px;">You are a professional AI assistant that helps analyze and process data from Tableau. Provide clear, concise, and insightful analysis based on the user\'s specific requirements. Use markdown formatting to structure your response with headers, bullet points, bold text, and proper organization for better readability.</textarea>
            </div>

            <hr style="margin: 18px 0;">
            <div class="form-group">
                <label for="apiKey">API Key:</label>
                <input type="password" id="apiKey" placeholder="Enter your API key">
            </div>
            <div class="form-group">
                <label for="apiEndpoint">API Endpoint: <span style="font-weight: normal; color: #888; font-size: 12px;">(Only for Azure, leave blank for OpenAI)</span></label>
                <input type="text" id="apiEndpoint" placeholder="https://swedencentral.api.cognitive.microsoft.com">
            </div>
            <div class="form-group">
                <label for="modelOrDeployment">Model (for OpenAI) or Deployment (for Azure):</label>
                <input type="text" id="modelOrDeployment" placeholder="e.g. gpt-4o-mini or your-deployment-name">
            </div>
            <div class="form-group" id="apiVersionGroup" style="display: none;">
                <label for="apiVersion">API Version (Azure only):</label>
                <input type="text" id="apiVersion" placeholder="2024-12-01-preview">
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 30px;">
                <button class="btn" onclick="saveConfiguration()">üíæ Save Configuration</button>
                <button class="btn btn-secondary" onclick="closeSettings()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        let dashboard, worksheets;
        let config = {
            worksheet: '',
            column: '',
            apiKey: '',
            apiEndpoint: '',
            modelOrDeployment: '',
            apiVersion: '',
            tokenLimit: 5000,
            systemRole: 'You are a professional text summarizer and analyst. Provide clear, concise, and insightful analysis that captures the essence of the provided text data. Use markdown formatting to structure your response with headers, bullet points, bold text, and proper organization for better readability.',
            customPrompt: 'Provide a comprehensive summary of the following text entries. Focus on the key themes, main points, and overall insights:'
        };

        // Variables for text formatting
        let currentRawText = '';
        let isFormatted = true;

        // Encryption/Decryption functions for sensitive data
        const ENCRYPTION_KEY = 'TableauAI2024!Secure#Key'; // Simple encryption key
        
        function encryptText(text) {
            if (!text) return '';
            try {
                // Simple XOR encryption with a key
                let encrypted = '';
                for (let i = 0; i < text.length; i++) {
                    const charCode = text.charCodeAt(i) ^ ENCRYPTION_KEY.charCodeAt(i % ENCRYPTION_KEY.length);
                    encrypted += String.fromCharCode(charCode);
                }
                // Convert to base64 for safe storage
                return btoa(encrypted);
            } catch (error) {
                console.error('Encryption error:', error);
                return text; // Fallback to plain text if encryption fails
            }
        }

        function decryptText(encryptedText) {
            if (!encryptedText) return '';
            try {
                // Check if it's encrypted (base64 format)
                if (!/^[A-Za-z0-9+/]*={0,2}$/.test(encryptedText)) {
                    return encryptedText; // Not encrypted, return as is
                }
                
                // Decode from base64
                const decoded = atob(encryptedText);
                let decrypted = '';
                for (let i = 0; i < decoded.length; i++) {
                    const charCode = decoded.charCodeAt(i) ^ ENCRYPTION_KEY.charCodeAt(i % ENCRYPTION_KEY.length);
                    decrypted += String.fromCharCode(charCode);
                }
                return decrypted;
            } catch (error) {
                console.error('Decryption error:', error);
                return encryptedText; // Return as is if decryption fails
            }
        }

        function encryptSensitiveData(configData) {
            const encryptedConfig = { ...configData };
            // Encrypt sensitive fields
            if (encryptedConfig.apiKey) {
                encryptedConfig.apiKey = encryptText(encryptedConfig.apiKey);
            }
            if (encryptedConfig.apiEndpoint) {
                encryptedConfig.apiEndpoint = encryptText(encryptedConfig.apiEndpoint);
            }
            if (encryptedConfig.modelOrDeployment) {
                encryptedConfig.modelOrDeployment = encryptText(encryptedConfig.modelOrDeployment);
            }
            if (encryptedConfig.apiVersion) {
                encryptedConfig.apiVersion = encryptText(encryptedConfig.apiVersion);
            }
            return encryptedConfig;
        }

        function decryptSensitiveData(configData) {
            const decryptedConfig = { ...configData };
            // Decrypt sensitive fields
            if (decryptedConfig.apiKey) {
                decryptedConfig.apiKey = decryptText(decryptedConfig.apiKey);
            }
            if (decryptedConfig.apiEndpoint) {
                decryptedConfig.apiEndpoint = decryptText(decryptedConfig.apiEndpoint);
            }
            if (decryptedConfig.modelOrDeployment) {
                decryptedConfig.modelOrDeployment = decryptText(decryptedConfig.modelOrDeployment);
            }
            if (decryptedConfig.apiVersion) {
                decryptedConfig.apiVersion = decryptText(decryptedConfig.apiVersion);
            }
            return decryptedConfig;
        }

        // Markdown to HTML parser for rich text formatting
        function parseMarkdown(text) {
            if (!text) return '';
            
            let html = text;
            
            // Split into lines for better processing
            let lines = html.split('\n');
            let processedLines = [];
            let inList = false;
            let listType = '';
            
            for (let i = 0; i < lines.length; i++) {
                let line = lines[i].trim();
                
                // Headers
                if (line.startsWith('### ')) {
                    processedLines.push(`<h3>${line.substring(4)}</h3>`);
                } else if (line.startsWith('## ')) {
                    processedLines.push(`<h2>${line.substring(3)}</h2>`);
                } else if (line.startsWith('# ')) {
                    processedLines.push(`<h1>${line.substring(2)}</h1>`);
                }
                // Horizontal rules
                else if (line === '---' || line === '***') {
                    processedLines.push('<hr>');
                }
                // Lists
                else if (line.match(/^[*-]\s+/)) {
                    if (!inList) {
                        processedLines.push('<ul>');
                        inList = true;
                        listType = 'ul';
                    }
                    processedLines.push(`<li>${line.substring(2)}</li>`);
                } else if (line.match(/^\d+\.\s+/)) {
                    if (!inList || listType !== 'ol') {
                        if (inList) processedLines.push(`</${listType}>`);
                        processedLines.push('<ol>');
                        inList = true;
                        listType = 'ol';
                    }
                    processedLines.push(`<li>${line.replace(/^\d+\.\s+/, '')}</li>`);
                }
                // Blockquotes
                else if (line.startsWith('> ')) {
                    processedLines.push(`<blockquote>${line.substring(2)}</blockquote>`);
                }
                // Empty lines
                else if (line === '') {
                    if (inList) {
                        processedLines.push(`</${listType}>`);
                        inList = false;
                    }
                    processedLines.push('');
                }
                // Regular paragraphs
                else {
                    if (inList) {
                        processedLines.push(`</${listType}>`);
                        inList = false;
                    }
                    processedLines.push(`<p>${line}</p>`);
                }
            }
            
            // Close any open list
            if (inList) {
                processedLines.push(`</${listType}>`);
            }
            
            html = processedLines.join('\n');
            
            // Process inline formatting
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
            html = html.replace(/__(.*?)__/g, '<strong>$1</strong>');
            html = html.replace(/_(.*?)_/g, '<em>$1</em>');
            
            // Code blocks
            html = html.replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>');
            html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
            
            // Clean up empty paragraphs and extra whitespace
            html = html.replace(/<p><\/p>/g, '');
            html = html.replace(/<p>\s*<\/p>/g, '');
            html = html.replace(/\n\s*\n/g, '\n');
            
            return html;
        }


        // Initialize the extension
        tableau.extensions.initializeAsync().then(() => {
            dashboard = tableau.extensions.dashboardContent.dashboard;
            worksheets = dashboard.worksheets;
            
            loadConfiguration();
            populateWorksheetDropdown();
            updateConfigStatus();
            
            if (worksheets.length > 0) {
                showStatus(`Extension initialized! Found ${worksheets.length} worksheet(s).`, 'success');
            } else {
                showStatus('‚ö†Ô∏è No worksheets found. Please add worksheets to your dashboard.', 'error');
            }
            
        }, (err) => {
            console.error('Error initializing extension:', err);
            showStatus('Error initializing extension: ' + err.message, 'error');
        });

        // Configuration Management
        function loadConfiguration() {
            try {
                // Try Tableau settings first
                const settings = tableau.extensions.settings.getAll();
                
                if (settings.textSummarizerConfig) {
                    const savedConfig = JSON.parse(settings.textSummarizerConfig);
                    // Decrypt sensitive data before loading
                    const decryptedConfig = decryptSensitiveData(savedConfig);
                    config = { ...config, ...decryptedConfig };
                } else {
                    // Fallback to localStorage for external hosting
                    const localConfig = localStorage.getItem('textSummarizerConfig');
                    if (localConfig) {
                        try {
                            const savedConfig = JSON.parse(localConfig);
                            const decryptedConfig = decryptSensitiveData(savedConfig);
                            config = { ...config, ...decryptedConfig };
                            console.log('Loaded configuration from localStorage fallback');
                        } catch (error) {
                            console.error('Error loading from localStorage:', error);
                        }
                    }
                }
                
                document.getElementById('worksheetSelect').value = config.worksheet || '';
                document.getElementById('columnSelect').value = config.column || '';
                document.getElementById('tokenLimit').value = config.tokenLimit || 5000;
                document.getElementById('systemRole').value = config.systemRole || '';
                document.getElementById('apiKey').value = config.apiKey || '';
                document.getElementById('apiEndpoint').value = config.apiEndpoint || '';
                document.getElementById('modelOrDeployment').value = config.modelOrDeployment || '';
                document.getElementById('apiVersion').value = config.apiVersion || '';
                showApiVersionField();

                // Load custom prompt from settings
                document.getElementById('customPrompt').value = config.customPrompt || 'Provide a comprehensive summary of the following text entries. Focus on the key themes, main points, and overall insights:';
            } catch (error) {
                console.error('Error loading configuration:', error);
                // Try localStorage as last resort
                try {
                    const localConfig = localStorage.getItem('textSummarizerConfig');
                    if (localConfig) {
                        const savedConfig = JSON.parse(localConfig);
                        const decryptedConfig = decryptSensitiveData(savedConfig);
                        config = { ...config, ...decryptedConfig };
                        console.log('Loaded configuration from localStorage after error');
                    }
                } catch (localError) {
                    console.error('Error loading from localStorage fallback:', localError);
                }
            }
        }

        function saveConfiguration() {
            try {
                config.worksheet = document.getElementById('worksheetSelect').value;
                config.column = document.getElementById('columnSelect').value;
                config.tokenLimit = parseInt(document.getElementById('tokenLimit').value) || 5000;
                config.systemRole = document.getElementById('systemRole').value;
                config.apiKey = document.getElementById('apiKey').value;
                config.apiEndpoint = document.getElementById('apiEndpoint').value;
                config.modelOrDeployment = document.getElementById('modelOrDeployment').value;
                config.apiVersion = document.getElementById('apiVersion').value;
                config.customPrompt = document.getElementById('customPrompt').value;
                
                // Encrypt sensitive data before saving
                const encryptedConfig = encryptSensitiveData(config);
                
                // Save to Tableau settings
                tableau.extensions.settings.set('textSummarizerConfig', JSON.stringify(encryptedConfig));
                tableau.extensions.settings.saveAsync().then(() => {
                    // Also save to localStorage as fallback
                    try {
                        localStorage.setItem('textSummarizerConfig', JSON.stringify(encryptedConfig));
                        console.log('Configuration saved to both Tableau settings and localStorage');
                    } catch (localError) {
                        console.warn('Could not save to localStorage:', localError);
                    }
                    
                    updateConfigStatus();
                    closeSettings();
                    showStatus('Configuration saved successfully!', 'success');
                }).catch(error => {
                    console.error('Error saving to Tableau settings:', error);
                    // Fallback to localStorage only
                    try {
                        localStorage.setItem('textSummarizerConfig', JSON.stringify(encryptedConfig));
                        console.log('Configuration saved to localStorage fallback');
                        updateConfigStatus();
                        closeSettings();
                        showStatus('Configuration saved to local storage!', 'success');
                    } catch (localError) {
                        console.error('Error saving to localStorage:', localError);
                        showStatus('Error saving configuration: ' + localError.message, 'error');
                    }
                });
            } catch (error) {
                console.error('Error saving configuration:', error);
                showStatus('Error saving configuration: ' + error.message, 'error');
            }
        }

        function updateConfigStatus() {
            const statusDiv = document.getElementById('configStatus');
            const isConfigured = config.worksheet && config.column && config.apiKey;
            
            if (isConfigured) {
                // Check if configured worksheet and column still exist
                const worksheetExists = worksheets && worksheets.find(ws => ws.name === config.worksheet);
                
                if (worksheetExists) {
                    statusDiv.className = 'config-status configured';
                    statusDiv.textContent = `‚úÖ Configured: ${config.worksheet} ‚Üí ${config.column}`;
                } else {
                    statusDiv.className = 'config-status not-configured';
                    statusDiv.textContent = `‚ö†Ô∏è Worksheet "${config.worksheet}" not found - Update configuration`;
                }
            } else {
                statusDiv.className = 'config-status not-configured';
                statusDiv.textContent = '‚ö†Ô∏è Configuration required - Click settings to setup';
            }
        }

        // Modal Management
        function openSettings() {
            document.getElementById('settingsModal').style.display = 'block';
            
            // Set current values
            document.getElementById('worksheetSelect').value = config.worksheet || '';
            document.getElementById('columnSelect').value = config.column || '';
            document.getElementById('tokenLimit').value = config.tokenLimit || 5000;
            document.getElementById('systemRole').value = config.systemRole || '';
            document.getElementById('apiKey').value = config.apiKey || '';
            document.getElementById('apiEndpoint').value = config.apiEndpoint || '';
            document.getElementById('modelOrDeployment').value = config.modelOrDeployment || '';
            document.getElementById('apiVersion').value = config.apiVersion || '';
            showApiVersionField();
            
            // Trigger column load if worksheet is selected
            if (config.worksheet) {
                onWorksheetChange();
            }
            
            // Add model selection event listener
            document.getElementById('modelOrDeployment').addEventListener('change', function() {
                const apiVersionGroup = document.getElementById('apiVersionGroup');
                if (this.value && this.value.includes('api.openai.com')) {
                    apiVersionGroup.style.display = 'none';
                } else {
                    apiVersionGroup.style.display = 'block';
                }
            });
        }

        function saveCustomPrompt() {
            try {
                config.customPrompt = document.getElementById('customPrompt').value;
                
                // Encrypt sensitive data before saving
                const encryptedConfig = encryptSensitiveData(config);
                
                // Save to Tableau settings
                tableau.extensions.settings.set('textSummarizerConfig', JSON.stringify(encryptedConfig));
                tableau.extensions.settings.saveAsync().then(() => {
                    // Also save to localStorage as fallback
                    try {
                        localStorage.setItem('textSummarizerConfig', JSON.stringify(encryptedConfig));
                        console.log('Custom prompt saved to both Tableau settings and localStorage');
                    } catch (localError) {
                        console.warn('Could not save to localStorage:', localError);
                    }
                    showStatus('Custom prompt saved successfully!', 'success');
                }).catch(error => {
                    console.error('Error saving to Tableau settings:', error);
                    // Fallback to localStorage only
                    try {
                        localStorage.setItem('textSummarizerConfig', JSON.stringify(encryptedConfig));
                        console.log('Custom prompt saved to localStorage fallback');
                        showStatus('Custom prompt saved to local storage!', 'success');
                    } catch (localError) {
                        console.error('Error saving to localStorage:', localError);
                        showStatus('Error saving custom prompt: ' + localError.message, 'error');
                    }
                });
            } catch (error) {
                console.error('Error saving custom prompt:', error);
                showStatus('Error saving custom prompt: ' + error.message, 'error');
            }
        }

        function closeSettings() {
            document.getElementById('settingsModal').style.display = 'none';
        }

        function showProviderFields() {
            const provider = document.getElementById('provider').value;
            document.getElementById('openaiFields').style.display = provider === 'openai' ? 'block' : 'none';
            document.getElementById('azureFields').style.display = provider === 'azure' ? 'block' : 'none';
        }
        document.getElementById('provider').addEventListener('change', showProviderFields);


        function populateWorksheetDropdown() {
            const worksheetSelect = document.getElementById('worksheetSelect');
            
            if (!worksheets || worksheets.length === 0) {
                worksheetSelect.innerHTML = '<option value="">‚ö†Ô∏è No worksheets found</option>';
                return;
            }
            
            worksheetSelect.innerHTML = '<option value="">Select a worksheet</option>';
            
            worksheets.forEach(worksheet => {
                const option = document.createElement('option');
                option.value = worksheet.name;
                option.textContent = worksheet.name;
                worksheetSelect.appendChild(option);
            });
            
            // Restore saved selection
            if (config.worksheet) {
                worksheetSelect.value = config.worksheet;
            }
            worksheetSelect.addEventListener('change', onWorksheetChange);
        }

        function onWorksheetChange() {
            const worksheetSelect = document.getElementById('worksheetSelect');
            const columnSelect = document.getElementById('columnSelect');
            const selectedWorksheetName = worksheetSelect.value;
            
            if (!selectedWorksheetName) {
                columnSelect.innerHTML = '<option value="">Select a worksheet first</option>';
                return;
            }
            
            const worksheet = worksheets.find(ws => ws.name === selectedWorksheetName);
            
            if (worksheet) {
                worksheet.getSummaryDataAsync().then(dataTable => {
                    populateColumnDropdown(dataTable.columns);
                }).catch(err => {
                    console.error('Error getting worksheet data:', err);
                    showStatus('Error loading worksheet columns: ' + err.message, 'error');
                });
            }
        }

        function populateColumnDropdown(columns) {
            const columnSelect = document.getElementById('columnSelect');
            columnSelect.innerHTML = '<option value="">Select a text column</option>';
            
            columns.forEach(column => {
                if (column.dataType === 'string') {
                    const option = document.createElement('option');
                    option.value = column.fieldName;
                    option.textContent = column.fieldName;
                    columnSelect.appendChild(option);
                }
            });
            
            // Restore saved selection
            if (config.column) {
                columnSelect.value = config.column;
            }
        }

        async function summarizeText() {
            const customPrompt = document.getElementById('customPrompt').value.trim();
            
            // Basic validation
            if (!config.worksheet || !config.column || !config.apiKey || !config.modelOrDeployment) {
                showStatus('Please configure your settings first (click the gear icon)', 'error');
                openSettings();
                return;
            }
            
            if (!customPrompt) {
                showStatus('Please enter a custom prompt', 'error');
                return;
            }
            
            try {
                showLoading(true);
                showStatus('Validating configuration...', 'info');
                
                // Check if configured worksheet still exists
                const worksheet = worksheets.find(ws => ws.name === config.worksheet);
                if (!worksheet) {
                    showLoading(false);
                    showStatus(`‚ùå Worksheet "${config.worksheet}" not found. Please update configuration.`, 'error');
                    openSettings();
                    return;
                }
                
                showStatus('Extracting data from Tableau...', 'info');
                const dataTable = await worksheet.getSummaryDataAsync();
                
                // Check if configured column still exists
                const columnIndex = dataTable.columns.findIndex(col => col.fieldName === config.column);
                if (columnIndex === -1) {
                    showLoading(false);
                    showStatus(`‚ùå Column "${config.column}" not found in worksheet "${config.worksheet}". Please update configuration.`, 'error');
                    openSettings();
                    return;
                }

                
                // Extract text data
                const textData = [];
                dataTable.data.forEach(row => {
                    const cellValue = row[columnIndex].value;
                    if (cellValue && typeof cellValue === 'string' && cellValue.trim()) {
                        textData.push(cellValue.trim());
                    }
                });
                
                if (textData.length === 0) {
                    throw new Error('No text data found in the selected column');
                }
                
                showStatus(`Found ${textData.length} text entries. Processing with AI...`, 'info');
                
                // Combine texts
                const combinedText = textData.join('\n\n---\n\n');
                
                // Apply token limit
                const maxLength = Math.min(config.tokenLimit * 4, 50000); // Rough char to token conversion
                const finalText = combinedText.length > maxLength 
                    ? combinedText.substring(0, maxLength) + '...\n\n[Text truncated due to token limit]'
                    : combinedText;
                
                // Create the full prompt
                const fullPrompt = `${customPrompt}\n\n${finalText}`;
                
                showStatus('Sending request to AI API...', 'info');
                
                let response;
                // Detect provider
                const isAzure = config.apiEndpoint && !config.apiEndpoint.includes('api.openai.com');
                if (isAzure) {
                    if (!config.apiEndpoint || !config.apiVersion) {
                        showStatus('Please provide Azure API Endpoint and API Version.', 'error');
                        showLoading(false);
                        return;
                    }
                    response = await fetch(config.apiEndpoint + '/openai/deployments/' + config.modelOrDeployment + '/chat/completions?api-version=' + config.apiVersion, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'api-key': config.apiKey
                        },
                        body: JSON.stringify({
                            messages: [
                                {
                                    role: 'system',
                                    content: config.systemRole
                                },
                                {
                                    role: 'user',
                                    content: fullPrompt
                                }
                            ],
                            max_tokens: Math.min(config.tokenLimit, 4000),
                            temperature: 0.3
                        })
                    });
                } else {
                    response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${config.apiKey}`
                        },
                        body: JSON.stringify({
                            model: config.modelOrDeployment,
                            messages: [
                                {
                                    role: 'system',
                                    content: config.systemRole
                                },
                                {
                                    role: 'user',
                                    content: fullPrompt
                                }
                            ],
                            max_tokens: Math.min(config.tokenLimit, 4000),
                            temperature: 0.3
                        })
                    });
                }
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || `API Error: ${response.status}`);
                }
                
                const result = await response.json();
                const summary = result.choices[0].message.content.trim();
                
                // Store the raw text and display formatted version
                currentRawText = summary;
                isFormatted = true;
                
                // Display the result
                document.getElementById('resultText').innerHTML = parseMarkdown(summary);
                document.getElementById('resultContainer').style.display = 'block';
                document.getElementById('formatToggle').textContent = 'üìù Plain Text';
                document.getElementById('formatToggle').classList.add('active');
                
                showStatus(`‚úÖ AI Analysis completed! Processed ${textData.length} entries.`, 'success');
                
            } catch (error) {
                console.error('Error:', error);
                
                // Handle specific error types
                if (error.message.includes('CORS') || error.message.includes('fetch')) {
                    showStatus('Network Error: Please check your internet connection and API key.', 'error');
                } else if (error.message.includes('401') || error.message.includes('Unauthorized')) {
                    showStatus('Invalid API Key: Please check your API key in settings.', 'error');
                } else if (error.message.includes('429')) {
                    showStatus('Rate Limit: Too many requests. Please wait and try again.', 'error');
                } else {
                    showStatus('Error: ' + error.message, 'error');
                }
            } finally {
                showLoading(false);
            }
        }

        function showLoading(show) {
            const loading = document.getElementById('loading');
            const btn = document.getElementById('summarizeBtn');
            
            if (show) {
                loading.style.display = 'block';
                btn.disabled = true;
            } else {
                loading.style.display = 'none';
                btn.disabled = false;
            }
        }

        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
            
            // Auto-hide success messages after 5 seconds
            if (type === 'success') {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
            }
        }

        function showApiVersionField() {
            const endpoint = document.getElementById('apiEndpoint').value;
            const group = document.getElementById('apiVersionGroup');
            if (endpoint && !endpoint.includes('api.openai.com')) {
                group.style.display = 'block';
            } else {
                group.style.display = 'none';
            }
        }

        function toggleFormat() {
            const resultText = document.getElementById('resultText');
            const toggleBtn = document.getElementById('formatToggle');
            
            if (isFormatted) {
                // Switch to plain text
                resultText.textContent = currentRawText;
                toggleBtn.textContent = 'üé® Formatted';
                toggleBtn.classList.remove('active');
                isFormatted = false;
            } else {
                // Switch to formatted text
                resultText.innerHTML = parseMarkdown(currentRawText);
                toggleBtn.textContent = 'üìù Plain Text';
                toggleBtn.classList.add('active');
                isFormatted = true;
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('settingsModal');
            if (event.target === modal) {
                closeSettings();
            }
        }
    </script>
</body>
</html> 